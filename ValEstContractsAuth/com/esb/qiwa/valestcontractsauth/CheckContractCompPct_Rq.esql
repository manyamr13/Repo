BROKER SCHEMA com.esb.qiwa.valestcontractsauth
PATH Qiwa.Framework.Lib;

DECLARE chec NAMESPACE 'http://www.ibm.com/rules/decisionservice/CheckContractCompliancePercentage_DC/CheckContractCompliancePercentage';
DECLARE par NAMESPACE 'http://www.ibm.com/rules/decisionservice/CheckContractCompliancePercentage_DC/CheckContractCompliancePercentage/param';
DECLARE soapenv NAMESPACE 'http://schemas.xmlsoap.org/soap/envelope/';

CREATE COMPUTE MODULE CheckContractCompPctRq
	CREATE FUNCTION Main() RETURNS BOOLEAN
	BEGIN
		IF FIELDNAME(Environment.Variables) IS NULL THEN
			CREATE FIELD Environment.Variables;
		END IF;

		DECLARE EV REFERENCE TO Environment.Variables;
		DECLARE channelRequest REFERENCE TO InputRoot.XMLNSC.ContractAuthenticationIndicatorRs;
		DECLARE loadedPropertiesRef REFERENCE TO Environment.Properties.ValEstContractsAuth.HTTP_ValEstContractsAuthFlow;
		
		SET OutputRoot.Properties = EV.Properties;
		SET OutputRoot.MQMD = EV.MQMD;
		SET OutputRoot.MQRFH2 = EV.MQRFH2;
		
		DECLARE TotalAuthenticationPercentage CHARACTER;
		DECLARE TotalAuthPercentageint DECIMAL;
		SET TotalAuthenticationPercentage = REPLACE(channelRequest.Body.TotalAuthenticationPercentage, '%', '');
		SET TotalAuthPercentageint = TotalAuthenticationPercentage;
		
		IF (Environment.Variables.XMLNSC.ValidateEstablishmentContractsAuthenticationRq.Body.LaborOfficeId = 1 AND
			Environment.Variables.XMLNSC.ValidateEstablishmentContractsAuthenticationRq.Body.SequenceNumber = 2875070)
			OR (Environment.Variables.XMLNSC.ValidateEstablishmentContractsAuthenticationRq.Body.LaborOfficeId = 1 AND
			Environment.Variables.XMLNSC.ValidateEstablishmentContractsAuthenticationRq.Body.SequenceNumber = 2669649) THEN
			
			CREATE LASTCHILD OF OutputRoot DOMAIN 'XMLNSC';
			CREATE FIRSTCHILD OF OutputRoot.XMLNSC.ValidateEstablishmentContractsAuthenticationRs NAME 'Header';
			CREATE LASTCHILD OF OutputRoot.XMLNSC.ValidateEstablishmentContractsAuthenticationRs NAME 'Body';
			-- return output as ValidateEstablishmentContractsAuthenticationRs
			DECLARE outBodyRef REFERENCE TO OutputRoot.XMLNSC.ValidateEstablishmentContractsAuthenticationRs.Body;
			DECLARE rOutHeaderRef REFERENCE TO OutputRoot.XMLNSC.ValidateEstablishmentContractsAuthenticationRs.Header;
			DECLARE rInputHeader REFERENCE TO EV.XMLNSC.ValidateEstablishmentContractsAuthenticationRq.Header;
			DECLARE EnglishDescription, ArabicDescription, STATUS, ESB_CODE, ChannnelId CHAR;
			
			CALL getEsbChannlsErrorCodeDescriptionFrom(loadedPropertiesRef.Variables.ODMError,'NULL',NULL,EnglishDescription,ArabicDescription,STATUS);
			SET outBodyRef.ErrorList.Error.ErrorCode = loadedPropertiesRef.Variables.ODMError;
			SET outBodyRef.ErrorList.Error.DescriptionAr = REPLACE(ArabicDescription,'XX', '49');
			SET outBodyRef.ErrorList.Error.DescriptionEn = REPLACE(EnglishDescription,'XX', '49');
			
			
			CALL Create_esbXML_Response_Header(loadedPropertiesRef.Variables.ValidationError,rInputHeader, rOutHeaderRef);
			propagate to terminal 'out1' delete none;
			RETURN FALSE;
		
		ELSEIF InputRoot.XMLNSC.ContractAuthenticationIndicatorRs.Body.TotalLaborersCount  = loadedPropertiesRef.Variables.Zero
			OR (Environment.Variables.XMLNSC.ValidateEstablishmentContractsAuthenticationRq.Body.LaborOfficeId = 1 AND
			Environment.Variables.XMLNSC.ValidateEstablishmentContractsAuthenticationRq.Body.SequenceNumber = 1929988)
			OR (Environment.Variables.XMLNSC.ValidateEstablishmentContractsAuthenticationRq.Body.LaborOfficeId = 1 AND
			Environment.Variables.XMLNSC.ValidateEstablishmentContractsAuthenticationRq.Body.SequenceNumber = 7850)
			
			OR (Environment.Variables.XMLNSC.ValidateEstablishmentContractsAuthenticationRq.Body.LaborOfficeId = 1 AND
			Environment.Variables.XMLNSC.ValidateEstablishmentContractsAuthenticationRq.Body.SequenceNumber = 24512)
			
			OR (Environment.Variables.XMLNSC.ValidateEstablishmentContractsAuthenticationRq.Body.LaborOfficeId = 11 AND
			Environment.Variables.XMLNSC.ValidateEstablishmentContractsAuthenticationRq.Body.SequenceNumber = 72687)
			
			OR (Environment.Variables.XMLNSC.ValidateEstablishmentContractsAuthenticationRq.Body.LaborOfficeId = 12 AND
			Environment.Variables.XMLNSC.ValidateEstablishmentContractsAuthenticationRq.Body.SequenceNumber = 47890)
			
			OR (Environment.Variables.XMLNSC.ValidateEstablishmentContractsAuthenticationRq.Body.LaborOfficeId = 15 AND
			Environment.Variables.XMLNSC.ValidateEstablishmentContractsAuthenticationRq.Body.SequenceNumber = 12908)
			
			OR (Environment.Variables.XMLNSC.ValidateEstablishmentContractsAuthenticationRq.Body.LaborOfficeId = 16 AND
			Environment.Variables.XMLNSC.ValidateEstablishmentContractsAuthenticationRq.Body.SequenceNumber = 13704)
			
			OR (Environment.Variables.XMLNSC.ValidateEstablishmentContractsAuthenticationRq.Body.LaborOfficeId = 1 AND
			Environment.Variables.XMLNSC.ValidateEstablishmentContractsAuthenticationRq.Body.SequenceNumber = 74512)
			
			OR (Environment.Variables.XMLNSC.ValidateEstablishmentContractsAuthenticationRq.Body.LaborOfficeId = 1 AND
			Environment.Variables.XMLNSC.ValidateEstablishmentContractsAuthenticationRq.Body.SequenceNumber = 179841)
			
			OR (Environment.Variables.XMLNSC.ValidateEstablishmentContractsAuthenticationRq.Body.LaborOfficeId = 4 AND
			Environment.Variables.XMLNSC.ValidateEstablishmentContractsAuthenticationRq.Body.SequenceNumber = 10000 AND CURRENT_DATE < CAST ('2024-10-02' AS DATE) )
			
			OR (Environment.Variables.XMLNSC.ValidateEstablishmentContractsAuthenticationRq.Body.LaborOfficeId = 15 AND
			Environment.Variables.XMLNSC.ValidateEstablishmentContractsAuthenticationRq.Body.SequenceNumber = 28019 AND CURRENT_DATE < CAST ('2024-01-16' AS DATE) )
			
	OR (Environment.Variables.XMLNSC.ValidateEstablishmentContractsAuthenticationRq.Body.LaborOfficeId = 4 AND
			Environment.Variables.XMLNSC.ValidateEstablishmentContractsAuthenticationRq.Body.SequenceNumber = 7259 AND CURRENT_DATE <= CAST ('2024-01-29' AS DATE) )		
			
	OR (Environment.Variables.XMLNSC.ValidateEstablishmentContractsAuthenticationRq.Body.LaborOfficeId = 1 AND
			Environment.Variables.XMLNSC.ValidateEstablishmentContractsAuthenticationRq.Body.SequenceNumber = 31106 AND CURRENT_DATE <= CAST ('2024-03-15' AS DATE) )		
	
	OR (Environment.Variables.XMLNSC.ValidateEstablishmentContractsAuthenticationRq.Body.LaborOfficeId = 1 AND
			Environment.Variables.XMLNSC.ValidateEstablishmentContractsAuthenticationRq.Body.SequenceNumber = 59989 AND CURRENT_DATE <= CAST ('2023-12-23' AS DATE) )						
			
		
	OR (Environment.Variables.XMLNSC.ValidateEstablishmentContractsAuthenticationRq.Body.LaborOfficeId = 1 AND
			Environment.Variables.XMLNSC.ValidateEstablishmentContractsAuthenticationRq.Body.SequenceNumber = 138584 AND CURRENT_DATE <= CAST ('2024-06-28' AS DATE) )						
			
	
	OR (Environment.Variables.XMLNSC.ValidateEstablishmentContractsAuthenticationRq.Body.LaborOfficeId = 15 AND
			Environment.Variables.XMLNSC.ValidateEstablishmentContractsAuthenticationRq.Body.SequenceNumber = 968 AND CURRENT_DATE <= CAST ('2024-07-01' AS DATE) )						
			
	OR (Environment.Variables.XMLNSC.ValidateEstablishmentContractsAuthenticationRq.Body.LaborOfficeId = 15 AND
			Environment.Variables.XMLNSC.ValidateEstablishmentContractsAuthenticationRq.Body.SequenceNumber = 1575509 AND CURRENT_DATE <= CAST ('2024-06-01' AS DATE) )						
					
	or (Environment.Variables.XMLNSC.ValidateEstablishmentContractsAuthenticationRq.Body.LaborOfficeId = 1 AND
			Environment.Variables.XMLNSC.ValidateEstablishmentContractsAuthenticationRq.Body.SequenceNumber = 59989 AND CURRENT_DATE <= CAST ('2024-07-07' AS DATE) )						
					
			THEN 
			CREATE LASTCHILD OF OutputRoot DOMAIN 'XMLNSC';
			CREATE FIRSTCHILD OF OutputRoot.XMLNSC.ValidateEstablishmentContractsAuthenticationRs NAME 'Header';
			CREATE LASTCHILD OF OutputRoot.XMLNSC.ValidateEstablishmentContractsAuthenticationRs NAME 'Body';
			-- return output as ValidateEstablishmentContractsAuthenticationRs
			DECLARE outBodyRef REFERENCE TO OutputRoot.XMLNSC.ValidateEstablishmentContractsAuthenticationRs.Body;
			DECLARE rOutHeaderRef REFERENCE TO OutputRoot.XMLNSC.ValidateEstablishmentContractsAuthenticationRs.Header;
			DECLARE rInputHeader REFERENCE TO EV.XMLNSC.ValidateEstablishmentContractsAuthenticationRq.Header;
			CALL Create_esbXML_Response_Header( GetESBSuccessCode(),rInputHeader, rOutHeaderRef);
			
			propagate to terminal 'out1' delete none;
			RETURN FALSE;
			
		ELSE
			
		
		CREATE LASTCHILD OF OutputRoot DOMAIN 'XMLNSC';
		SET OutputRoot.XMLNSC.soapenv:Envelope.(XMLNSC.NamespaceDecl)xmlns:soapenv = soapenv;
		SET OutputRoot.XMLNSC.soapenv:Envelope.(XMLNSC.NamespaceDecl)xmlns:chec = chec;
		SET OutputRoot.XMLNSC.soapenv:Envelope.(XMLNSC.NamespaceDecl)xmlns:par = par;				 

		SET OutputRoot.XMLNSC.soapenv:Envelope.soapenv:Body.chec:CheckContractCompliancePercentageRequest.chec:DecisionID = channelRequest.Header.TransactionId; 
		SET OutputRoot.XMLNSC.soapenv:Envelope.soapenv:Body.chec:CheckContractCompliancePercentageRequest.par:CheckContractCompliancePercentageReq.CheckContractCompliancePercentageReq.ServiceCode = loadedPropertiesRef.Variables.ServiceCode;
		SET OutputRoot.XMLNSC.soapenv:Envelope.soapenv:Body.chec:CheckContractCompliancePercentageRequest.par:CheckContractCompliancePercentageReq.CheckContractCompliancePercentageReq.ContractCompliancePercentage = TotalAuthPercentageint;
		
		SET OutputLocalEnvironment.Destination.SOAP.Request.Transport.HTTP.WebServiceURL = loadedPropertiesRef.Variables.ODMURL;	
		SET OutputRoot.HTTPRequestHeader."Authorization" = loadedPropertiesRef.Variables.Authorization;
		RETURN TRUE;
		END IF;
	END;

	CREATE PROCEDURE CopyMessageHeaders() BEGIN
		DECLARE I INTEGER 1;
		DECLARE J INTEGER;
		SET J = CARDINALITY(InputRoot.*[]);
		WHILE I < J DO
			SET OutputRoot.*[I] = InputRoot.*[I];
			SET I = I + 1;
		END WHILE;
	END;

	CREATE PROCEDURE CopyEntireMessage() BEGIN
		SET OutputRoot = InputRoot;
	END;
END MODULE;